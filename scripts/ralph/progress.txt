# Ralph Progress Log
Started: Mon Jan 19 16:23:04 EST 2026
---

## Codebase Patterns
- **Playwright configs**: Project already had playwright.config.ts for screenshots. E2E tests use separate playwright.e2e.config.ts to avoid conflicts.
- **E2E test script**: `npm run test:e2e` uses `--config playwright.e2e.config.ts`
- **New user redirect flow**: New users → /dashboard → empty state (with CTAs to /hi, /templates, /create). Not direct to /hi.
- **Session sync issue**: After magic link auth, the Header component's useSession may not immediately reflect the logged-in state. Use `page.reload()` + `waitForLoadState("networkidle")` to ensure session is fully established before interacting with authenticated UI elements.
- **Welcome back modal**: Marcus (and other returning users) may see a "Welcome back!" modal. Dismiss with `page.getByText("Not today, remind me tomorrow")`.
- **Headless UI Menu**: The user dropdown uses Headless UI Menu. Target dropdown items via `getByText("Logout", { exact: true })` rather than role selectors.
- **Empty state testing**: All seeded personas have programs. Use fresh signup (unique email) to test empty state/onboarding flows.
- **Serial mode for seed-dependent tests**: Use `test.describe.configure({ mode: "serial" })` for test files that call seedPersonas() in beforeAll to avoid parallel worker race conditions.
- **Rest day dashboard state**: After completing a workout for the day, dashboard shows "REST DAY" with "Time to recover". Use "Train anyway" button or "Start workout" in Quick Log section to navigate to workout page.
- **Workout completion responses**: Completing a workout can show (1) share modal with Skip button, (2) celebration screen with Continue/Close button, or (3) direct dashboard redirect. Use Promise.race to handle all cases.

---

## 2026-01-19 - US-001: Install and configure Playwright for Next.js
- Installed @playwright/test@1.57.0 as devDependency
- Created playwright.e2e.config.ts with:
  - testDir: ./tests/e2e
  - baseURL: http://localhost:3001
  - webServer config to run npm run dev
  - chromium project with Desktop Chrome
- Added "test:e2e": "playwright test --config playwright.e2e.config.ts" to package.json
- Created tests/e2e/.gitkeep placeholder
- Verified: npx playwright test --version = 1.57.0
- Verified: npm run lint and npm run build pass
- **Learnings for future iterations:**
  - Existing playwright.config.ts is for screenshot tests in tests/screenshots/
  - Must use separate config file (playwright.e2e.config.ts) to avoid breaking existing screenshot workflow
  - Screenshot scripts use --project flag to specify Desktop Chrome or Mobile Safari
- **Auth flow (dev mode)**: Magic link stored in cookie `baisics.__dev_magic_link`. Verify page shows "Click here to sign in →" link.
- **No typecheck script**: Project uses `npm run build` for type verification. Acceptance criteria mentioning typecheck should use build instead.
---

## 2026-01-19 - US-002: Create auth test fixture with magic link helper
- Created tests/fixtures/auth.ts with:
  - `loginAsUser(page, email)`: navigates to signin, enters email, clicks submit, waits for verify page, clicks dev magic link
  - `logoutUser(page)`: finds and clicks logout button in header, waits for redirect to /
- Files created: tests/fixtures/auth.ts
- Verified: npm run lint passes (warnings only)
- Verified: npm run build passes
- **Learnings for future iterations:**
  - Signin page has "Send magic link" button (not "Continue with Email")
  - Dev magic link shows as "Click here to sign in →" on verify-request page
  - Logout uses signOut from next-auth with callbackUrl: '/'
  - After login, users redirect to /dashboard (existing user) or /hi (new user)
---

## 2026-01-19 - US-003: Create persona fixture for test data
- Created tests/fixtures/personas.ts with:
  - `PersonaTier` type: "free" | "paid"
  - `PersonaJourney` type: "fresh" | "early" | "week2" | "cruising" | "veteran" | "returning" | "lapsed"
  - `Persona` interface: email, tier, journey, workoutCount, hasProgram
  - `PERSONAS` object with all 11 test users (alex, sarah, jordan, chris, kim, taylor, robert, marcus, priya, derek, maya)
  - `getPersona(name)` helper function with type-safe name parameter
- Files created: tests/fixtures/personas.ts
- Verified: npm run lint passes (warnings only)
- Verified: npm run build passes
- **Learnings for future iterations:**
  - Persona data is in prisma/seed-data/personas/*.json
  - Full persona docs at docs/personas.md
  - Use `as const` on PERSONAS object for strict typing
  - PersonaName type derived from keyof typeof PERSONAS
---

## 2026-01-19 - US-004: Create database seed helper for E2E tests
- Created tests/fixtures/seed.ts with:
  - `seedPersonas()`: runs `npx prisma db seed` with 30s timeout
  - `resetAndSeedPersonas()`: runs `npx prisma migrate reset --force` with 30s timeout (bonus helper)
  - Both return Promises that resolve on success, reject on failure/timeout
- Files created: tests/fixtures/seed.ts
- Verified: npm run lint passes (warnings only)
- Verified: npm run build passes
- **Learnings for future iterations:**
  - Uses hardcoded commands (no user input) so shell execution is safe
  - timeout option on process handles the 30s timeout automatically
  - Added resetAndSeedPersonas() for tests that need completely clean state
  - Use seedPersonas() in beforeAll for most tests, resetAndSeedPersonas() only when necessary
---

## 2026-01-19 - US-005: Auth test: Magic link signup (new user)
- Created tests/e2e/auth/signup.spec.ts
- Test flow: signin → enter unique email → magic link → verify redirect
- Verified: npx playwright test tests/e2e/auth/signup.spec.ts passes
- Verified: npm run lint and npm run build pass
- Files created: tests/e2e/auth/signup.spec.ts
- **Learnings for future iterations:**
  - New users are redirected to /dashboard (not /hi directly)
  - Dashboard shows empty state with onboarding CTAs when user has no programs
  - "Create with AI" CTA links to /hi
  - Test verifies the actual app behavior, not the PRD assumption
  - Unique email pattern: `test-${Date.now()}@test.baisics.app`
---

## 2026-01-19 - US-006: Auth test: Magic link signin (returning user)
- Created tests/e2e/auth/signin.spec.ts
- Test flow: seed personas → login as marcus → verify dashboard with program name
- Uses beforeAll to call seedPersonas() before tests
- Uses loginAsUser fixture with getPersona helper for clean, reusable code
- Verifies redirect to /dashboard/{programId} (users with programs go to dashboard/[programId])
- Verifies "PPL Hypertrophy Program" heading is visible
- Files created: tests/e2e/auth/signin.spec.ts
- Verified: npm run lint and npm run build pass
- Verified: npx playwright test tests/e2e/auth/signin.spec.ts passes (18.3s)
- **Learnings for future iterations:**
  - Returning users redirect to /dashboard/{programId}, not just /dashboard
  - Use `**/dashboard/**` pattern to match any dashboard URL
  - Marcus's program name is "PPL Hypertrophy Program" (from prisma/seed-data/personas/marcus.json)
  - Program name displayed in h1 heading on dashboard
---

## 2026-01-19 - US-007: Auth test: Signout clears session
- Created tests/e2e/auth/signout.spec.ts
- Test flow: seed personas → login as marcus → dismiss modal → reload page → click avatar → click logout → verify landing → verify protected route redirect
- Files created: tests/e2e/auth/signout.spec.ts
- Verified: npm run lint and npm run build pass
- Verified: npx playwright test tests/e2e/auth/signout.spec.ts passes (24.2s)
- **Learnings for future iterations:**
  - Must reload page after login to ensure Header shows authenticated state (useSession sync issue)
  - "Welcome back!" modal must be dismissed before interacting with header menu
  - User menu opened by clicking avatar button in header (button with .rounded-full child)
  - Logout button in Headless UI Menu.Item - target via `getByText("Logout", { exact: true })`
  - After logout: redirect to `/`, then `/dashboard` redirects to `/auth/signin`
---

## 2026-01-19 - US-008: Auth test: Protected routes redirect unauthenticated users
- Created tests/e2e/auth/protected-routes.spec.ts
- Three tests verifying unauthenticated access to protected routes:
  - /dashboard → redirects to /auth/signin
  - /settings → redirects to /auth/signin
  - /check-in → redirects to /auth/signin
- Files created: tests/e2e/auth/protected-routes.spec.ts
- Verified: npm run lint and npm run build pass
- Verified: npx playwright test tests/e2e/auth/protected-routes.spec.ts passes (6.8s, all 3 tests)
- **Learnings for future iterations:**
  - Protected route tests are simpler than auth tests - no need for seeding or login fixtures
  - Next.js middleware handles the redirects to /auth/signin
  - Tests run in parallel (3 workers) since they're independent
---

## 2026-01-19 - US-009: Onboarding test: Empty state dashboard shows CTAs
- Created tests/e2e/onboarding/empty-state.spec.ts
- Test flow: signin with unique email → magic link → verify dashboard shows all 3 CTAs
- Verifies all three onboarding CTAs:
  - "Create with AI" → href="/hi"
  - "Browse Templates" → href="/templates"
  - "Import your own" → href="/create"
- Also verifies "No active program" heading (confirms empty state)
- Files created: tests/e2e/onboarding/empty-state.spec.ts
- Verified: npm run lint and npm run build pass
- Verified: npx playwright test tests/e2e/onboarding/empty-state.spec.ts passes (7.9s)
- **Learnings for future iterations:**
  - alex@test.baisics.app has a program in seed data, so use fresh signup for true empty state
  - Empty state CTAs are in src/app/dashboard/page.tsx (not a separate component)
  - All personas have hasProgram: true, so fresh signups are the only way to get empty state
  - Can use getByRole("link", { name: /text/i }) then toHaveAttribute("href", path) to verify links
---

## 2026-01-19 - US-010: Dashboard test: Main dashboard loads with all components
- Created tests/e2e/dashboard/main-dashboard.spec.ts with 4 tests:
  - Main test: verifies program name, workout selector (Day X button), workout stats (X/Y workouts)
  - Weekly Progress test: verifies section title and streak indicator
  - Quick Log test: verifies section with "Log food" and "Log weight" buttons
  - Recent Activity test: verifies section is present
- Uses serial mode (`test.describe.configure({ mode: "serial" })`) to avoid seed race conditions
- Files created: tests/e2e/dashboard/main-dashboard.spec.ts
- Verified: npm run lint passes (warnings only)
- Verified: npm run build passes
- Verified: npx playwright test tests/e2e/dashboard/main-dashboard.spec.ts passes (27.0s, all 4 tests)
- **Learnings for future iterations:**
  - Parallel workers can cause seed race conditions with duplicate data errors
  - Use `test.describe.configure({ mode: "serial" })` for test files that share seed data
  - Dashboard sections have identifiable text labels: "Today's Workout", "Weekly Progress", "Quick Log", "Recent Activity"
  - Workout selector is a button containing "Day X:" pattern
  - Stats show as "X/Y" (e.g., "3/3") with "workouts" label below
  - Console error filtering: exclude Tawk.to errors, favicon errors, React warnings for cleaner assertions
- **Workout page auto-start**: The /workout/[id] page automatically creates a workout log when loaded - there is no separate "Start Workout" button on the workout page itself. The "Start Workout" link is on the dashboard and navigates to /workout/[id].
- **Strict element matching**: Use `{ exact: true }` when matching link/button names that might appear multiple times (e.g., dashboard has multiple "Start Workout" related elements).
---

## 2026-01-19 - US-011: Workout test: Start workout loads exercises
- Created tests/e2e/workout/start-workout.spec.ts with 4 tests:
  - Navigation test: verifies clicking "Start Workout" on dashboard navigates to /workout/[id]
  - Exercise display test: verifies "Exercise X of Y" indicator and exercise name heading
  - Progress bar test: verifies "Workout in Progress" text and "X of Y sets complete" display
  - Navigation buttons test: verifies Previous/Next buttons exist, and either Next or Complete Workout button is visible
- Uses serial mode to avoid seed race conditions
- Uses `{ exact: true }` for "Start Workout" link to avoid matching multiple elements
- Files created: tests/e2e/workout/start-workout.spec.ts
- Verified: npm run lint passes (warnings only)
- Verified: npm run build passes
- Verified: npx playwright test tests/e2e/workout/start-workout.spec.ts passes (26.8s, all 4 tests)
- **Learnings for future iterations:**
  - Workout page auto-starts workout (creates workout log on load)
  - Dashboard "Start Workout" link has exact text "Start Workout" - use exact: true
  - Workout page shows "Workout in Progress" header with percentage
  - "X of Y sets complete" pattern for progress tracking
  - Exercise header shows "Exercise X of Y" pattern
  - Exercise name is in h3.text-2xl element
  - Navigation: Previous button always visible, Next OR Complete Workout button visible
---

## 2026-01-19 - US-012: Workout test: Log exercise set
- Created tests/e2e/workout/log-exercise.spec.ts with 2 tests:
  - Main test: login as marcus, navigate to workout, fill weight (185) and reps (8), click "Complete Set 1", verify "185×8" appears in SetProgressGrid
  - Sequential logging test: log two sets in sequence, verify both appear with correct weight×reps display, verify progress count increases
- Uses serial mode to avoid seed race conditions
- Files created: tests/e2e/workout/log-exercise.spec.ts
- Verified: npm run lint passes (warnings only)
- Verified: npm run build passes
- Verified: npx playwright test tests/e2e/workout/log-exercise.spec.ts passes (23.0s, 2 tests)
- **Learnings for future iterations:**
  - BigSetInputCard component has two number inputs: first for weight, second for reps
  - Use `page.locator('input[type="number"]').first()` and `.nth(1)` to select weight and reps inputs
  - "Complete Set N" button pattern: `page.getByRole("button", { name: /Complete Set \d+/ })`
  - After completing a set, the SetProgressGrid shows "weight×reps" format (e.g., "185×8")
  - UI automatically advances to next set after completion (shows "Complete Set 2" button)
  - Progress text follows pattern "X of Y sets complete"
  - Workout logs don't persist across page reloads in the same way - navigating back to workout URL may create new workout log
---

## 2026-01-19 - US-013: Workout test: Complete workout updates status
- Created tests/e2e/workout/complete-workout.spec.ts with combined test:
  - Login as marcus, navigate to workout, log one set (185×8)
  - Navigate to last exercise using quick nav buttons
  - Click "Complete Workout" button
  - Handle completion response (share modal skip, celebration continue, or direct dashboard redirect)
  - Verify on dashboard and check Recent Activity shows today's date
- Files created: tests/e2e/workout/complete-workout.spec.ts
- Verified: npm run lint passes (warnings only)
- Verified: npm run build passes
- Verified: npx playwright test tests/e2e/workout/complete-workout.spec.ts passes (27.5s)
- **Learnings for future iterations:**
  - After completing a workout, dashboard may show "REST DAY" state with "Time to recover" message
  - On rest day, "Start Workout" link is NOT visible in main area; use alternatives:
    - "Start workout" in Quick Log section (lowercase)
    - "Train anyway: [workout name]" button
  - Workout completion can trigger: share modal (Skip button), celebration screen (Continue/Close/Done), or direct dashboard redirect
  - Use Promise.race to handle multiple completion response possibilities
  - Recent Activity section shows completed workouts with "Mon DD" date format
  - Quick nav buttons for exercises use class `button.w-10.h-10.rounded-lg`
---
