# Ralph Progress Log
Started: Sun Jan 18 17:57:58 EST 2026
---

## Codebase Patterns

### USDA API Integration
- Service layer: `src/lib/usda/` with types.ts and client.ts
- Nutrient IDs: ENERGY=1008, PROTEIN=1003, CARBS=1005, FAT=1004
- API uses POST for search, GET for details
- `simplifyFood()` extracts macros from nutrient array

### Component Patterns
- Design colors constant: `COLORS = { white, gray50, gray100, gray400, gray600, navy, navyLight, coral, coralDark, coralLight }`
- Reference: `src/components/nutrition/IngredientSwapModal.tsx` for modal patterns
- Use `useCallback` for handlers passed as deps to other hooks
- ARIA combobox: `role="combobox"` goes on input, not container

---

## 2026-01-18 17:59 - US-001: Create USDA FoodData Central API service
- Created `src/lib/usda/types.ts` with USDAFood, USDASearchResult, FoodNutrient, SimplifiedFood types
- Created `src/lib/usda/client.ts` with searchFoods() and getFoodDetails() functions
- Added USDA_API_KEY to .env.example with signup link
- Exported simplifyFood() helper to extract calories, protein, carbs, fat
- **Learnings for future iterations:**
  - This project has no `npm run typecheck` script - use `npm run build` which includes type checking
  - USDA API uses POST for search endpoint (not GET with query params)
  - API key is in .issues.json notes field for issue #122
---

## 2026-01-18 18:05 - US-002: Create food search API endpoint
- Created `src/app/api/foods/search/route.ts`
- GET endpoint with `?q=query&limit=10` params
- Returns 400 for missing/short queries (<2 chars)
- Returns empty `{ foods: [] }` if no USDA results
- Returns 502 for USDA API errors
- Uses `searchFoods()` and `simplifyFood()` from USDA client
- **Learnings for future iterations:**
  - API routes follow pattern: import NextResponse, parse searchParams from URL, return JSON
  - Similar search endpoints exist: `/api/exercise-library/search` for reference
  - No auth required for this public food search endpoint
---

## 2026-01-18 18:15 - US-003: Create FoodSearchAutocomplete component
- Created `src/components/nutrition/FoodSearchAutocomplete.tsx`
- Input with 300ms debounce, search icon, loading spinner
- Dropdown shows food name, brand badge, macros per 100g
- Full keyboard nav: ArrowUp/Down, Enter to select, Escape to close
- Proper ARIA combobox pattern (role="combobox" on input)
- Empty state: "No foods found for [query]"
- Uses SimplifiedFood type from USDA types
- **Learnings for future iterations:**
  - ARIA combobox: `role="combobox"` goes on input, not container
  - Must define `useCallback` handlers BEFORE hooks that use them in deps
  - Click outside detection: `mousedown` event + contains() check
  - Use `scrollIntoView({ block: 'nearest' })` for keyboard nav scroll
---

## 2026-01-18 18:25 - US-004: Create ServingSizeSelector component
- Created `src/components/nutrition/ServingSizeSelector.tsx`
- Props: `food` (SimplifiedFood), `onConfirm` callback, optional `onCancel`, `className`
- Number input for grams (default 100), validated to >= 0
- Quick buttons: 50g, 100g, 150g, 200g with coral highlight for selected
- Live calculation via `useMemo` showing calories, protein, carbs, fat
- `CalculatedMacros` type exported for consumers: { grams, calories, protein, carbs, fat, food }
- Macros rounded: calories to whole number, others to 1 decimal
- Confirm button calls `onConfirm(calculatedMacros)`
- **Learnings for future iterations:**
  - Use `useMemo` for derived calculations that depend on state
  - Nutrition display pattern: coral background (coralLight), coral text for numbers, gray600 for labels
  - Export both component and associated types for consumer convenience
---

## 2026-01-18 18:45 - US-005: Add recent foods cache per user
- Created `src/app/api/foods/recent/route.ts` (placeholder for future server-side storage)
- Created `src/lib/foods/recentFoods.ts` with localStorage helpers:
  - `getRecentFoods(userId)` - returns last 10 unique foods
  - `addRecentFood(userId, food)` - adds food to front, dedupes by fdcId
  - `clearRecentFoods(userId)` - clears user's recent foods
- Updated `FoodSearchAutocomplete.tsx`:
  - Added `userId` prop (defaults to 'anonymous')
  - Shows recent foods dropdown when input empty/focused
  - "Recent" header label above recent foods list
  - Selecting food adds it to recent cache
  - Keyboard nav works for both search results and recents
- **Learnings for future iterations:**
  - localStorage key pattern: `baisics_recent_foods_${userId}`
  - When dropdown has header element, offset scrollIntoView index by 1
  - `showingRecent` state flag differentiates between recent vs search mode
  - Can migrate to DB later by updating API route and keeping same component interface
---
