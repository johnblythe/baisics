# Exercise Library

The exercise library is the foundation of the lean program generation system. It provides static exercise data (instructions, equipment, muscle targets) that doesn't need to be generated by AI for each program.

## Overview

| Metric | Value |
|--------|-------|
| Total exercises | ~1,055 |
| Data source | [free-exercise-db](https://github.com/yuhonas/free-exercise-db) |
| Last import | 2024 (via `import-exercises.ts`) |

## Schema

```prisma
model ExerciseLibrary {
  id               String            @id
  name             String            @unique
  category         String            // "strength", "stretching", etc.
  equipment        String[]          // ["barbell", "dumbbell"]
  instructions     String[]          // Form cues
  commonMistakes   String[]
  benefits         String[]
  difficulty       Difficulty        // BEGINNER, INTERMEDIATE, ADVANCED
  isCompound       Boolean
  movementPattern  MovementPattern   // PUSH, PULL, HINGE, SQUAT, etc.
  targetMuscles    MuscleGroup[]
  secondaryMuscles MuscleGroup[]
  images           String[]

  // Lean generation fields
  defaultTier       ExerciseTier    // TIER_1, TIER_2, TIER_3
  contraindications String[]        // ["knee", "shoulder"]
  environments      String[]        // ["gym", "home"]
}
```

## Tier Classification

Exercises are classified into tiers for workout ordering:

| Tier | Description | Examples |
|------|-------------|----------|
| TIER_1 | Main compound lifts - typically first | Squat, Deadlift, Bench, Row, OHP |
| TIER_2 | Supporting movements - typically middle | Lunges, RDLs, Dips, Pull-ups |
| TIER_3 | Accessories/isolation - typically last | Curls, Raises, Crunches |

**Note:** Tiers are defaults, not rules. AI can override based on user needs (e.g., rehab focus).

## Scripts

### Import Exercises

Pulls exercises from free-exercise-db and populates the library.

```bash
# Dry run - see what would be imported
npx tsx src/scripts/import-exercises.ts --dry-run

# Run import
npx tsx src/scripts/import-exercises.ts
```

### Classify Tiers

Classifies exercises into TIER_1/2/3 based on heuristics.

```bash
# Dry run - see classification changes
npx tsx src/scripts/classify-tiers.ts --dry-run

# Apply classification
npx tsx src/scripts/classify-tiers.ts
```

## Adding New Exercises

### Option 1: Manual via Prisma

```typescript
await prisma.exerciseLibrary.create({
  data: {
    name: "New Exercise",
    category: "strength",
    equipment: ["dumbbell"],
    instructions: ["Step 1", "Step 2", "Step 3"],
    difficulty: "INTERMEDIATE",
    isCompound: true,
    movementPattern: "PUSH",
    targetMuscles: ["CHEST", "TRICEPS"],
    defaultTier: "TIER_2",
    environments: ["gym", "home"],
  },
});
```

### Option 2: AI-Generated (current behavior)

When AI generates a program with an unknown exercise, `getOrCreateExercise()` in `exerciseMatcher.ts` creates a sparse entry:

```typescript
// Creates minimal entry if exact match not found
await prisma.exerciseLibrary.upsert({
  where: { name },
  update: {},
  create: { name, category: 'default' },
});
```

These sparse entries should be enriched later with full details.

## Maintenance Tasks

### Finding Sparse Entries

```sql
SELECT name, category, array_length(instructions, 1) as instruction_count
FROM exercise_library
WHERE category = 'default'
   OR array_length(instructions, 1) IS NULL
   OR array_length(instructions, 1) = 0
ORDER BY name;
```

### Re-running Classification

If you add new exercises or update the classification logic:

```bash
npx tsx src/scripts/classify-tiers.ts
```

### Adding Contraindications

Contraindications should be added for exercises that are risky for certain conditions:

```typescript
// Example: update exercises with knee contraindication
await prisma.exerciseLibrary.updateMany({
  where: {
    name: { in: ['Jump Squat', 'Box Jump', 'Lunge Jump'] },
  },
  data: {
    contraindications: ['knee'],
  },
});
```

Common contraindication tags:
- `knee` - ACL, meniscus, patella issues
- `shoulder` - Impingement, rotator cuff
- `lower-back` - Disc issues, sciatica
- `neck` - Cervical spine issues
- `wrist` - Carpal tunnel, sprains

### Adding Environments

Environments indicate where an exercise can be performed:

```typescript
// Example: tag bodyweight exercises for home/travel
await prisma.exerciseLibrary.updateMany({
  where: {
    equipment: { isEmpty: true },
  },
  data: {
    environments: ['home', 'travel', 'outdoors'],
  },
});
```

Environment tags:
- `gym` - Requires gym equipment
- `home` - Can do at home with minimal equipment
- `travel` - Can do in hotel room/limited space
- `outdoors` - Parks, trails, outdoor spaces

## Exercise Matching

The `exerciseMatcher.ts` module provides fuzzy matching for AI-generated exercise names:

```typescript
import { findMatchingExercise, getOrCreateExercise } from '@/utils/exerciseMatcher';

// Find best match (returns null if no good match)
const match = await findMatchingExercise("DB Bench Press");
// { id: "...", name: "Dumbbell Bench Press", score: 0.85, exact: false }

// Get or create (always returns an exercise)
const exercise = await getOrCreateExercise("Goblet Squat");
// { id: "...", name: "Goblet Squat", wasMatched: true }
```

## Future Improvements

- [ ] Add video URLs for common exercises
- [ ] Implement contraindication filtering in lean prompt
- [ ] Add environment filtering in lean prompt
- [ ] Create admin UI for exercise management
- [ ] Periodic sync with upstream exercise database
